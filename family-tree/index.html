<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Build your family tree - Forever Fields memorial family tree visualization">
    <title>Family Tree - Forever Fields</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="../css/style.css">

    <style>
        /* Header */
        .dashboard-header {
            background: var(--warm-white);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--sage-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .dashboard-header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: var(--font-serif);
            font-size: 1.25rem;
            color: var(--gray-dark);
            text-decoration: none;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-body);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: var(--sage-primary);
        }

        /* Main Container */
        .family-tree-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--gray-body);
            font-size: 1.1rem;
        }

        /* Toolbar */
        .tree-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--sage-pale);
            border-radius: 12px;
        }

        .tree-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .tree-controls button {
            padding: 0.625rem 1.25rem;
            border: 1px solid var(--sage-light);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-dark);
            transition: all 0.2s ease;
        }

        .tree-controls button:hover {
            background: var(--sage-light);
            border-color: var(--sage-primary);
        }

        .add-member-btn {
            padding: 0.75rem 1.5rem;
            background: var(--sage-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .add-member-btn:hover {
            background: var(--sage-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 176, 133, 0.3);
        }

        /* Tree Visualization */
        .tree-wrapper {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
            min-height: 500px;
        }

        .tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .tree-node {
            position: relative;
            text-align: center;
            margin: 1rem 0;
        }

        .tree-level {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin: 2rem 0;
            position: relative;
        }

        .tree-level::before {
            content: '';
            position: absolute;
            top: -2rem;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--sage-light);
        }

        .member-card {
            position: relative;
            background: var(--cream);
            border: 2px solid var(--sage-light);
            border-radius: 12px;
            padding: 1rem;
            width: 180px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .member-card:hover {
            border-color: var(--sage-primary);
            box-shadow: 0 4px 12px rgba(139, 176, 133, 0.2);
            transform: translateY(-2px);
        }

        .member-card.subject {
            border-color: var(--sage-primary);
            border-width: 3px;
            background: linear-gradient(135deg, var(--sage-pale) 0%, var(--cream) 100%);
        }

        .member-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 0.75rem;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .member-photo.placeholder {
            background: var(--sage-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .member-name {
            font-family: var(--font-serif);
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 0.25rem;
        }

        .member-dates {
            font-size: 0.75rem;
            color: var(--gray-body);
        }

        .member-relationship {
            font-size: 0.75rem;
            color: var(--sage-dark);
            font-weight: 500;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: var(--sage-pale);
            border-radius: 6px;
            display: inline-block;
        }

        .connector {
            position: absolute;
            width: 2px;
            background: var(--sage-light);
            left: 50%;
            transform: translateX(-1px);
        }

        .connector-vertical {
            height: 2rem;
            top: -2rem;
        }

        /* Empty State */
        .tree-empty {
            text-align: center;
            padding: 4rem 2rem;
        }

        .tree-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .tree-empty h2 {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            color: var(--gray-dark);
            margin-bottom: 0.75rem;
        }

        .tree-empty p {
            color: var(--gray-body);
            margin-bottom: 1.5rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-body);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--sage-pale);
            color: var(--gray-dark);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1.5px solid var(--sage-light);
            border-radius: 8px;
            font-family: var(--font-sans);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--sage-primary);
            box-shadow: 0 0 0 3px rgba(167, 201, 162, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-actions button {
            flex: 1;
            padding: 0.875rem;
            border-radius: 8px;
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel {
            background: var(--cream);
            border: 1px solid var(--sage-light);
            color: var(--gray-dark);
        }

        .btn-cancel:hover {
            background: var(--sage-pale);
        }

        .btn-save {
            background: var(--sage-primary);
            border: none;
            color: white;
        }

        .btn-save:hover {
            background: var(--sage-dark);
        }

        .optional {
            color: var(--gray-light);
            font-weight: 400;
            font-size: 0.85rem;
        }

        .field-hint {
            font-size: 0.8rem;
            color: var(--gray-body);
            margin-top: 0.25rem;
            display: block;
        }

        /* Tier Restriction Banner */
        .tier-restriction {
            background: linear-gradient(135deg, #fff8f0 0%, #f5e6d3 100%);
            border: 2px solid #e6b87a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .tier-restriction h3 {
            font-family: var(--font-serif);
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .tier-restriction p {
            color: var(--gray-body);
            margin-bottom: 1rem;
        }

        .upgrade-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #d4a574 0%, #c19563 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.4);
        }

        @media (max-width: 768px) {
            .tree-level {
                gap: 1.5rem;
            }

            .member-card {
                width: 140px;
                padding: 0.75rem;
            }

            .member-photo {
                width: 60px;
                height: 60px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="dashboard-header-inner">
            <a href="/" class="logo">
                <span>üåø</span>
                <span>Forever Fields</span>
            </a>

            <div class="header-actions">
                <a href="../dashboard" class="back-link">
                    <span>‚Üê</span>
                    <span>Back to Dashboard</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="family-tree-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 id="treeTitle">Family Tree</h1>
            <p id="treeSubtitle">Visualize and preserve your family connections</p>
        </div>

        <!-- Tier Restriction (shown for FREE tier) -->
        <div class="tier-restriction" id="tierRestriction" style="display: none;">
            <h3>üåü Unlock Family Tree</h3>
            <p>Family tree visualization is available with Forever and Healing & Heritage plans.</p>
            <button class="upgrade-btn" onclick="window.location.href='/pricing'">
                Upgrade to Access
            </button>
        </div>

        <!-- Toolbar -->
        <div class="tree-toolbar">
            <div class="tree-controls">
                <button onclick="resetView()">‚Üª Reset View</button>
                <button onclick="expandAll()">+ Expand All</button>
                <button onclick="collapseAll()">‚àí Collapse All</button>
            </div>
            <button class="add-member-btn" onclick="openAddMemberModal()">
                + Add Family Member
            </button>
        </div>

        <!-- Tree Visualization -->
        <div class="tree-wrapper">
            <div id="familyTree" class="tree">
                <!-- Tree will be rendered here dynamically -->
                <div class="tree-empty">
                    <div class="tree-empty-icon">üå≥</div>
                    <h2>Start Building Your Family Tree</h2>
                    <p>Add family members to create a beautiful visualization of your family history.</p>
                    <button class="add-member-btn" onclick="openAddMemberModal()">
                        Add First Family Member
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Member Modal -->
    <div class="modal-overlay" id="memberModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">√ó</button>

            <div class="modal-header">
                <h2 id="modalTitle">Add Family Member</h2>
                <p style="color: var(--gray-body); font-size: 0.9rem;">Fill in the details below</p>
            </div>

            <form id="memberForm" onsubmit="saveMember(event)">
                <div class="form-group">
                    <label for="memberName">Full Name</label>
                    <input type="text" id="memberName" name="name" required placeholder="e.g., John Smith">
                </div>

                <div class="form-group">
                    <label for="memberRelationship">Relationship</label>
                    <select id="memberRelationship" name="relationship" required>
                        <option value="">Select relationship...</option>
                        <option value="parent">Parent</option>
                        <option value="child">Child</option>
                        <option value="spouse">Spouse</option>
                        <option value="sibling">Sibling</option>
                        <option value="grandparent">Grandparent</option>
                        <option value="grandchild">Grandchild</option>
                        <option value="aunt_uncle">Aunt/Uncle</option>
                        <option value="niece_nephew">Niece/Nephew</option>
                        <option value="cousin">Cousin</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="memberBirthDate">Birth Date <span class="optional">(optional)</span></label>
                        <input type="date" id="memberBirthDate" name="birthDate">
                    </div>
                    <div class="form-group">
                        <label for="memberDeathDate">Passing Date <span class="optional">(optional)</span></label>
                        <input type="date" id="memberDeathDate" name="deathDate">
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="memberIsLiving" name="isLiving" style="width: auto; margin-right: 0.5rem;">
                        This person is still living
                    </label>
                </div>

                <div class="form-group">
                    <label for="memberPhoto">Photo URL <span class="optional">(optional)</span></label>
                    <input type="url" id="memberPhoto" name="photoUrl" placeholder="https://example.com/photo.jpg">
                    <span class="field-hint">Link to a photo (upload feature coming soon)</span>
                </div>

                <div class="form-group">
                    <label for="memberNotes">Notes <span class="optional">(optional)</span></label>
                    <textarea id="memberNotes" name="notes" rows="3" placeholder="Additional information about this person..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-save">Save Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/api-client.js"></script>
    <script>
        // Get memorial ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const memorialId = urlParams.get('memorial');

        let familyMembers = [];
        let currentMemorial = null;
        let userTier = 'FREE'; // Will be loaded from API

        // Load memorial and family tree data
        async function loadFamilyTree() {
            try {
                if (!memorialId) {
                    alert('No memorial selected');
                    window.location.href = '/dashboard';
                    return;
                }

                // Load memorial data
                const memorial = await api.getMemorial(memorialId);
                currentMemorial = memorial;

                document.getElementById('treeTitle').textContent = `${memorial.deceasedName}'s Family Tree`;

                // Check user tier
                const user = await api.getCurrentUser();
                userTier = user.subscriptionTier || 'FREE';

                // Check tier restriction
                if (userTier === 'FREE') {
                    document.getElementById('tierRestriction').style.display = 'block';
                    document.querySelector('.tree-toolbar').style.display = 'none';
                    document.querySelector('.tree-wrapper').style.display = 'none';
                    return;
                }

                // Load family members
                familyMembers = await api.getFamilyMembers(memorialId);
                renderTree();

            } catch (error) {
                console.error('Error loading family tree:', error);
                alert('Failed to load family tree. Please try again.');
            }
        }

        // Render the family tree
        function renderTree() {
            const treeContainer = document.getElementById('familyTree');

            if (familyMembers.length === 0) {
                treeContainer.innerHTML = `
                    <div class="tree-empty">
                        <div class="tree-empty-icon">üå≥</div>
                        <h2>Start Building Your Family Tree</h2>
                        <p>Add family members to create a beautiful visualization of your family history.</p>
                        <button class="add-member-btn" onclick="openAddMemberModal()">
                            Add First Family Member
                        </button>
                    </div>
                `;
                return;
            }

            // Group members by generation
            const generations = {};
            familyMembers.forEach(member => {
                const gen = member.generation || 0;
                if (!generations[gen]) generations[gen] = [];
                generations[gen].push(member);
            });

            // Sort generations (ascending order: grandparents first)
            const sortedGens = Object.keys(generations).sort((a, b) => parseInt(a) - parseInt(b));

            let html = '<div class="tree">';

            sortedGens.forEach(gen => {
                html += '<div class="tree-level">';
                generations[gen].forEach(member => {
                    html += renderMemberCard(member, parseInt(gen) === 0);
                });
                html += '</div>';
            });

            html += '</div>';
            treeContainer.innerHTML = html;
        }

        // Render individual member card
        function renderMemberCard(member, isSubject = false) {
            const birthYear = member.birthDate ? new Date(member.birthDate).getFullYear() : '?';
            const deathYear = member.deathDate ? new Date(member.deathDate).getFullYear() : (member.isLiving ? 'present' : '?');

            const photoHtml = member.photoUrl
                ? `<img src="${member.photoUrl}" alt="${member.name}" class="member-photo">`
                : `<div class="member-photo placeholder">üë§</div>`;

            return `
                <div class="tree-node">
                    <div class="member-card ${isSubject ? 'subject' : ''}" onclick="editMember('${member.id}')">
                        ${photoHtml}
                        <div class="member-name">${member.name}</div>
                        <div class="member-dates">${birthYear} - ${deathYear}</div>
                        ${member.relationship ? `<div class="member-relationship">${formatRelationship(member.relationship)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Format relationship for display
        function formatRelationship(rel) {
            const map = {
                'parent': 'Parent',
                'child': 'Child',
                'spouse': 'Spouse',
                'sibling': 'Sibling',
                'grandparent': 'Grandparent',
                'grandchild': 'Grandchild',
                'aunt_uncle': 'Aunt/Uncle',
                'niece_nephew': 'Niece/Nephew',
                'cousin': 'Cousin',
                'other': 'Other'
            };
            return map[rel] || rel;
        }

        // Open add member modal
        function openAddMemberModal() {
            document.getElementById('modalTitle').textContent = 'Add Family Member';
            document.getElementById('memberForm').reset();
            document.getElementById('memberModal').classList.add('active');
        }

        // Edit member
        function editMember(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            document.getElementById('modalTitle').textContent = 'Edit Family Member';
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberRelationship').value = member.relationship;
            document.getElementById('memberBirthDate').value = member.birthDate ? member.birthDate.split('T')[0] : '';
            document.getElementById('memberDeathDate').value = member.deathDate ? member.deathDate.split('T')[0] : '';
            document.getElementById('memberIsLiving').checked = member.isLiving;
            document.getElementById('memberPhoto').value = member.photoUrl || '';
            document.getElementById('memberNotes').value = member.notes || '';

            document.getElementById('memberForm').dataset.editingId = memberId;
            document.getElementById('memberModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('memberModal').classList.remove('active');
            document.getElementById('memberForm').reset();
            delete document.getElementById('memberForm').dataset.editingId;
        }

        // Save member
        async function saveMember(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = {
                memorialId: memorialId,
                name: formData.get('name'),
                relationship: formData.get('relationship'),
                birthDate: formData.get('birthDate') || null,
                deathDate: formData.get('deathDate') || null,
                isLiving: formData.get('isLiving') === 'on',
                photoUrl: formData.get('photoUrl') || null,
                notes: formData.get('notes') || null,
                generation: calculateGeneration(formData.get('relationship'))
            };

            try {
                const editingId = form.dataset.editingId;

                if (editingId) {
                    // Update existing
                    await api.updateFamilyMember(editingId, data);
                } else {
                    // Create new
                    await api.createFamilyMember(data);
                }

                closeModal();
                await loadFamilyTree();

            } catch (error) {
                console.error('Error saving family member:', error);
                alert('Failed to save family member. Please try again.');
            }
        }

        // Calculate generation based on relationship
        function calculateGeneration(relationship) {
            const genMap = {
                'grandparent': -2,
                'parent': -1,
                'spouse': 0,
                'sibling': 0,
                'child': 1,
                'grandchild': 2,
                'aunt_uncle': -1,
                'niece_nephew': 1,
                'cousin': 0,
                'other': 0
            };
            return genMap[relationship] || 0;
        }

        // Tree controls
        function resetView() {
            loadFamilyTree();
        }

        function expandAll() {
            // Future feature: expand collapsed nodes
            alert('Expand/collapse feature coming soon!');
        }

        function collapseAll() {
            // Future feature: collapse nodes
            alert('Expand/collapse feature coming soon!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFamilyTree();
        });

        // Close modal on outside click
        document.getElementById('memberModal').addEventListener('click', (e) => {
            if (e.target.id === 'memberModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
