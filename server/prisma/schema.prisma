generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  name              String?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  memorials         Memorial[]
  pushSubscriptions PushSubscription[]

  @@map("users")
}

model Memorial {
  id                String           @id @default(uuid())
  ownerId           String           @map("owner_id")
  deceasedName      String           @map("deceased_name")
  deceasedNameLower String           @map("deceased_name_lower")
  birthDate         DateTime?        @map("birth_date")
  deathDate         DateTime?        @map("death_date")
  gotchaDate        DateTime?        @map("gotcha_date")
  portraitUrl       String?          @map("portrait_url")
  shortBio          String?          @map("short_bio")
  isPet             Boolean          @default(false) @map("is_pet")
  privacy           Privacy          @default(private)
  songSpotifyUri    String?          @map("song_spotify_uri")
  songYoutubeUrl    String?          @map("song_youtube_url")
  restingType       String?          @map("resting_type")
  restingLocation   Json?            @map("resting_location")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  candles           Candle[]
  guestbookEntries  GuestbookEntry[]
  invitations       Invitation[]
  owner             User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  memories          Memory[]
  pendingItems      PendingItem[]
  photos            Photo[]
  qrCode            QRCode?
  reports           Report[]
  socialLinks       SocialLink?
  timeCapsules      TimeCapsule[]
  voiceNotes        VoiceNote[]

  @@unique([deceasedNameLower, birthDate], name: "unique_memorial_birth")
  @@unique([deceasedNameLower, deathDate], name: "unique_memorial_death")
  @@index([ownerId])
  @@index([privacy])
  @@index([deceasedNameLower])
  @@map("memorials")
}

model PendingItem {
  id         String            @id @default(uuid())
  memorialId String            @map("memorial_id")
  type       PendingItemType
  dataJson   Json              @map("data_json")
  status     PendingItemStatus @default(pending)
  createdAt  DateTime          @default(now()) @map("created_at")
  memorial   Memorial          @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId, status])
  @@map("pending_items")
}

model Invitation {
  id         String     @id @default(uuid())
  memorialId String     @map("memorial_id")
  email      String
  role       InviteRole
  token      String     @unique
  expiresAt  DateTime   @map("expires_at")
  usedAt     DateTime?  @map("used_at")
  memorial   Memorial   @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([memorialId])
  @@map("invitations")
}

model Candle {
  id         String   @id @default(uuid())
  memorialId String   @map("memorial_id")
  message    String?
  name       String?
  createdAt  DateTime @default(now()) @map("created_at")
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId, createdAt])
  @@map("candles")
}

model TimeCapsule {
  id          String    @id @default(uuid())
  memorialId  String    @map("memorial_id")
  messageText String?   @map("message_text")
  voiceUrl    String?   @map("voice_url")
  videoUrl    String?   @map("video_url")
  unlockDate  DateTime  @map("unlock_date")
  openedAt    DateTime? @map("opened_at")
  memorial    Memorial  @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId, unlockDate])
  @@map("time_capsules")
}

model SocialLink {
  memorialId String   @id @map("memorial_id")
  facebook   String?
  instagram  String?
  tiktok     String?
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@map("social_links")
}

model QRCode {
  memorialId String   @id @map("memorial_id")
  design     QRDesign @default(minimalist)
  createdAt  DateTime @default(now()) @map("created_at")
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@map("qrcodes")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  keysJson  Json     @map("keys_json")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model MagicLink {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@index([email])
  @@map("magic_links")
}

model LoginAttempt {
  id         String   @id @default(uuid())
  email      String
  ipAddress  String   @map("ip_address")
  userAgent  String?  @map("user_agent")
  success    Boolean
  failReason String?  @map("fail_reason")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

model Session {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  token        String    @unique
  ipAddress    String    @map("ip_address")
  userAgent    String?   @map("user_agent")
  lastActivity DateTime  @default(now()) @map("last_activity")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  details   Json?
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model Photo {
  id         String   @id @default(uuid())
  memorialId String   @map("memorial_id")
  url        String
  publicId   String?  @map("public_id")
  caption    String?
  uploadedBy String   @default("Anonymous") @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@map("photos")
}

model Memory {
  id                 String   @id @default(uuid())
  memorialId         String   @map("memorial_id")
  title              String
  content            String
  authorName         String   @map("author_name")
  authorRelationship String?  @map("author_relationship")
  createdAt          DateTime @default(now()) @map("created_at")
  memorial           Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@map("memories")
}

model GuestbookEntry {
  id           String   @id @default(uuid())
  memorialId   String   @map("memorial_id")
  name         String
  message      String
  relationship String?
  createdAt    DateTime @default(now()) @map("created_at")
  memorial     Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@map("guestbook_entries")
}

model VoiceNote {
  id         String   @id @default(uuid())
  memorialId String   @map("memorial_id")
  url        String
  publicId   String?  @map("public_id")
  duration   Int      @default(0)
  authorName String   @default("Anonymous") @map("author_name")
  createdAt  DateTime @default(now()) @map("created_at")
  memorial   Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@map("voice_notes")
}

model Report {
  id            String    @id @default(uuid())
  memorialId    String    @map("memorial_id")
  contentType   String    @map("content_type")
  contentId     String    @map("content_id")
  reason        String
  reporterName  String?   @map("reporter_name")
  reporterEmail String?   @map("reporter_email")
  status        String    @default("pending")
  createdAt     DateTime  @default(now()) @map("created_at")
  resolvedAt    DateTime? @map("resolved_at")
  memorial      Memorial  @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
  @@index([status])
  @@map("reports")
}

enum Privacy {
  private
  link
  public

  @@map("privacy")
}

enum PendingItemType {
  photo
  memory
  guestbook
  voice_note
  song
  social
  time_capsule

  @@map("pending_item_type")
}

enum PendingItemStatus {
  pending
  approved
  rejected

  @@map("pending_item_status")
}

enum InviteRole {
  editor
  viewer

  @@map("invite_role")
}

enum QRDesign {
  marble
  garden
  gold
  minimalist

  @@map("qr_design")
}
